<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Compute variable importance using Shapley (R2) values — getShapleyR2 • SEMdeep</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Compute variable importance using Shapley (R2) values — getShapleyR2"><meta property="og:description" content="This function computes variable contributions for individual
predictions using the Shapley values, a method from cooperative game
theory where the variable values of an observation work together to achieve
the prediction. In addition, to make variable contributions easily explainable, 
the function decomposes the entire model R-Squared (R2 or the coefficient
of determination) into variable-level attributions of the variance
(Redell, 2019)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SEMdeep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/BarbaraTarantino/SEMdeep/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Compute variable importance using Shapley (R2) values</h1>
    <small class="dont-index">Source: <a href="https://github.com/BarbaraTarantino/SEMdeep/blob/HEAD/R/SEMml.R" class="external-link"><code>R/SEMml.R</code></a></small>
    <div class="hidden name"><code>getShapleyR2.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function computes variable contributions for individual
predictions using the Shapley values, a method from cooperative game
theory where the variable values of an observation work together to achieve
the prediction. In addition, to make variable contributions easily explainable, 
the function decomposes the entire model R-Squared (R2 or the coefficient
of determination) into variable-level attributions of the variance
(Redell, 2019).</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">getShapleyR2</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, thr <span class="op">=</span> <span class="cn">NULL</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>object</dt>
<dd><p>A model fitting object from <code><a href="SEMml.html">SEMml()</a></code> function.</p></dd>


<dt>newdata</dt>
<dd><p>A matrix containing new data with rows corresponding to
subjects, and columns to variables.</p></dd>


<dt>thr</dt>
<dd><p>A threshold value to apply to signed Shapley (R2) values. If
thr=NULL (default), the threshold is set to thr=mean(Shapley(R2) values)).</p></dd>


<dt>verbose</dt>
<dd><p>A logical value. If FALSE (default), the processed
graph will not be plotted to screen.</p></dd>


<dt>...</dt>
<dd><p>Currently ignored.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>A list od three object: (i) data.frame including the connections
together with their signed Shapley R-squred values; (ii) the dag with
colored edges, if abs(sign_R2) &gt; thr will be highlighted in red (sign_R2 &gt; 0)
or blue (sign_R2 &lt; 0); and (ii) the list of individual Shapley values of
predictors variables per each response variable.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>Lundberg &amp; Lee (2017) proposed a unified approach to both
local explainability (the variable contribution of a single variable within
a single sample) and global explainability (the variable contribution of the
entire model) by applying the fair distribution of payoffs principles from
game theory put forth by Shapley (1953). Now called SHAP (SHapley Additive
exPlanations), this suggested framework explains predictions of ML models,
where input variables take the place of players, and their contribution to
a particular prediction is measured using Shapley values. 
Successively, Redell (2019) presented a metric that combines the additive 
property of Shapley values with the robustness of the R2 of Gelman (2018) 
to produce an R2 variance decomposition that accurately captures the 
contribution of each variable to the explanatory power of the model. 
Additionally, we use the signed R2, in order to denote the regulation
of connections in line with a linear SEM, since the edges in the DAG
indicate node regulation (activation, if positive; inhibition, if
negative). This has been recovered for each edge using sign(beta), i.e.,
the sign of the coefficient estimates from a linear model (lm) fitting
of the output node on the input nodes, as suggested by Joseph (2019).
It should be noted that in order to ascertain the local significance
of node regulation with respect to the DAG, the Shapley decomposition
of the R-squared (R2) value can be employed for each outcome node
(r=1,...,R) by averaging the R2 indices of their input nodes.</p>
<p>The Shapley values are computed using the <span class="pkg">shapr</span> package that implements
an extended version of the Kernel SHAP method for approximating Shapley values
in which dependence between the features is taken into account. 
The operations necessary to compute kernel SHAP values are inherently
time-consuming, with the computational time increasing in proportion to
the number of predictor variables and the number of observations.
Therefore, the function uses a progress bar to check the progress
of the kernel SHAP evaluation per observation.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Shapley, L. (1953) A Value for n-Person Games. In: Kuhn, H. and Tucker, A., 
Eds., Contributions to the Theory of Games II, Princeton University Press,
Princeton, 307-317.</p>
<p>Scott M. Lundberg, Su-In Lee. (2017). A unified approach to interpreting 
model predictions. In Proceedings of the 31st International Conference on 
Neural Information Processing Systems (NIPS'17). Curran Associates Inc., 
Red Hook, NY, USA, 4768–4777.</p>
<p>Redell, N. (2019). Shapley Decomposition of R-Squared in Machine Learning 
Models. arXiv: Methodology.</p>
<p>Gelman, A., Goodrich, B., Gabry, J., &amp; Vehtari, A. (2019). R-squared for 
Bayesian Regression Models. The American Statistician, 73(3), 307–309.</p>
<p>Joseph, A. Parametric inference with universal function approximators (2019).
Bank of England working papers 784, Bank of England, revised 22 Jul 2020.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Mario Grassi <a href="mailto:mario.grassi@unipv.it">mario.grassi@unipv.it</a></p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># load ALS data</span></span></span>
<span class="r-in"><span><span class="va">ig</span><span class="op">&lt;-</span> <span class="va">alsData</span><span class="op">$</span><span class="va">graph</span></span></span>
<span class="r-in"><span><span class="va">data</span><span class="op">&lt;-</span> <span class="va">alsData</span><span class="op">$</span><span class="va">exprs</span></span></span>
<span class="r-in"><span><span class="va">data</span><span class="op">&lt;-</span> <span class="fu">transformData</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">$</span><span class="va">data</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Conducting the nonparanormal transformation via shrunkun ECDF...done.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#...with train-test (0.5-0.5) samples</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">train</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">rf0</span><span class="op">&lt;-</span> <span class="fu"><a href="SEMml.html">SEMml</a></span><span class="op">(</span><span class="va">ig</span>, <span class="va">data</span>, train<span class="op">=</span><span class="va">train</span>, algo<span class="op">=</span><span class="st">"rf"</span>, vimp<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 : z10452 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 : z1432 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 : z1616 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 : z4217 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 : z4741 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6 : z4744 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7 : z4747 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8 : z54205 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9 : z5530 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10 : z5532 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11 : z5533 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12 : z5534 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 13 : z5535 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 14 : z5600 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 15 : z5603 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 16 : z5606 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 17 : z5608 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 18 : z596 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 19 : z6300 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20 : z79139 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 21 : z836 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 22 : z84134 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 23 : z842 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  RF solver ended normally after 23 iterations </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  logL: -33.2711  srmr: 0.0860057 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">res</span><span class="op">&lt;-</span> <span class="fu">getShapleyR2</span><span class="op">(</span><span class="va">rf0</span>, <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">train</span>, <span class="op">]</span>, thr<span class="op">=</span><span class="cn">NULL</span>, verbose<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   |                                                                              |                                                                      |   0%  |                                                                              |===                                                                   |   4%  |                                                                              |======                                                                |   9%  |                                                                              |=========                                                             |  13%  |                                                                              |============                                                          |  17%  |                                                                              |===============                                                       |  22%  |                                                                              |==================                                                    |  26%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |===========================                                           |  39%  |                                                                              |==============================                                        |  43%  |                                                                              |=================================                                     |  48%  |                                                                              |=====================================                                 |  52%  |                                                                              |========================================                              |  57%  |                                                                              |===========================================                           |  61%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  74%  |                                                                              |=======================================================               |  78%  |                                                                              |==========================================================            |  83%  |                                                                              |=============================================================         |  87%  |                                                                              |================================================================      |  91%  |                                                                              |===================================================================   |  96%  |                                                                              |======================================================================| 100%</span>
<span class="r-plt img"><img src="getShapleyR2-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu">E</span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">dag</span><span class="op">)</span><span class="op">$</span><span class="va">color</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     gray50       red2 royalblue3 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         27          8         10 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># average shapley R2 across response variables</span></span></span>
<span class="r-in"><span><span class="va">R2</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">res4</span><span class="op">$</span><span class="va">est</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in eval(expr, envir, enclos):</span> object 'res4' not found</span>
<span class="r-in"><span><span class="va">Y</span><span class="op">&lt;-</span> <span class="va">res4</span><span class="op">$</span><span class="va">est</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in eval(expr, envir, enclos):</span> object 'res4' not found</span>
<span class="r-in"><span><span class="va">R2Y</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">R2</span><span class="op">~</span><span class="va">Y</span>,data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">R2</span>,<span class="va">Y</span><span class="op">)</span>,FUN<span class="op">=</span><span class="st">"mean"</span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in data.frame(R2, Y):</span> object 'R2' not found</span>
<span class="r-in"><span><span class="va">PE</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">rf0</span>, <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">train</span>, <span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">PE</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>R2Y<span class="op">=</span><span class="va">R2Y</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,PEY<span class="op">=</span><span class="va">PE</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in cbind(R2Y = R2Y[, 2], PEY = PE[-1]):</span> object 'R2Y' not found</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">R2</span><span class="op">)</span> <span class="co"># total average R2</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in mean(R2):</span> object 'R2' not found</span>
<span class="r-in"><span><span class="va">PE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>    <span class="co"># total MSE</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     amse </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1.110585 </span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Mario Grassi, Barbara Tarantino.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>


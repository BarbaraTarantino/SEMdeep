<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Compute variable importance using Shapley (R2) values — getShapleyR2 • SEMdeep</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Compute variable importance using Shapley (R2) values — getShapleyR2"><meta property="og:description" content="This function computes a model-agnostic variable importance
based on a Shapley-value decomposition of the model R-Squared (R2, i.e., the
coefficient of determination) that allocates the proportion of model-
explained variability in the data to each model feature (Redell, 2019)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SEMdeep</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/BarbaraTarantino/SEMdeep/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Compute variable importance using Shapley (R2) values</h1>
    <small class="dont-index">Source: <a href="https://github.com/BarbaraTarantino/SEMdeep/blob/HEAD/R/SEMml.R" class="external-link"><code>R/SEMml.R</code></a></small>
    <div class="hidden name"><code>getShapleyR2.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function computes a model-agnostic variable importance
based on a Shapley-value decomposition of the model R-Squared (R2, i.e., the
coefficient of determination) that allocates the proportion of model-
explained variability in the data to each model feature (Redell, 2019).</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">getShapleyR2</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">newdata</span>,</span>
<span>  newoutcome <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  thr <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ncores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>A model fitting object from <code><a href="SEMml.html">SEMml()</a></code>, or <code>SEMrun()</code>
functions.</p></dd>


<dt id="arg-newdata">newdata<a class="anchor" aria-label="anchor" href="#arg-newdata"></a></dt>
<dd><p>A matrix containing new data with rows corresponding to subjects,
and columns to variables.</p></dd>


<dt id="arg-newoutcome">newoutcome<a class="anchor" aria-label="anchor" href="#arg-newoutcome"></a></dt>
<dd><p>A new character vector (as.factor) of labels for a categorical
output (target)(default = NULL).</p></dd>


<dt id="arg-thr">thr<a class="anchor" aria-label="anchor" href="#arg-thr"></a></dt>
<dd><p>A numeric value [0-1] indicating the threshold to apply to the
signed Shapley R2 to color the graph. If thr = NULL (default), the
threshold is set to thr = 0.5*max(abs(signed Shapley R2 values)).</p></dd>


<dt id="arg-ncores">ncores<a class="anchor" aria-label="anchor" href="#arg-ncores"></a></dt>
<dd><p>number of cpu cores (default = 2)</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>A logical value. If FALSE (default), the processed
graph will not be plotted to screen.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Currently ignored.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>A list od four object: (i) shapx: the list of individual Shapley values
of predictors variables per each response variable; (ii) est: a data.frame including
the connections together with their signed Shapley R-squred values; (iii) gest:
if the outcome vector is given, a data.frame of signed Shapley R-squred values per
outcome levels; and (iv) dag: DAG with colored edges/nodes. If abs(sign_r2) &gt; thr
and sign_r2 &lt; 0, the edge is inhibited and it is highlighted in blue; otherwise,
if abs(sign_r2) &gt; thr and sign_r2 &gt; 0, the edge is activated and it is highlighted
in red. If the outcome vector is given, nodes with absolute connection weights
summed over the outcome levels, i.e. sum(abs(sign_r2[outcome levels])) &gt; thr, will
be highlighted in pink.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>Shapley values (Shapley, 1953; Lundberg &amp; Lee, 2017) apply the fair
distribution of payoffs principles from game theory to measure the additive
contribution of individual predictors in a ML model. The function compute
a signed Shapley R2 metric, that combines the additive property of Shapley
values with the robustness of the R-squared (R2) of Gelman (2018) to produce
a variance decomposition that accurately captures the contribution
of each variable in the ML model, see Redell (2019). The signed values are
used in order to denote the regulation of connections in line with a linear
model, since the edges in the DAG indicate node regulation (activation, if
positive; inhibition, if negative). The sign has been recovered for each edge
using sign(beta), i.e., the sign of the coefficient estimates from a linear
model (lm) fitting of the output node on the input nodes (see Joseph, 2019).
Furthermore, to determine the local significance of node regulation in the DAG,
the Shapley decomposition of the R-squared values for each outcome node (r=1,...,R)
can be done by summing the Shapley R2 indices of their input nodes.
It should be noted that the operations required to compute Shapley values processed
with the <code><a href="https://rdrr.io/pkg/kernelshap/man/kernelshap.html" class="external-link">kernelshap</a></code> function of the <span class="pkg">kernelshap</span> R
package are inherently time-consuming, with the computational time increasing in
proportion to the number of predictor variables and the number of observations.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Shapley, L. (1953) A Value for n-Person Games. In: Kuhn, H. and Tucker, A.,
Eds., Contributions to the Theory of Games II, Princeton University Press,
Princeton, 307-317.</p>
<p>Scott M. Lundberg, Su-In Lee. (2017). A unified approach to interpreting
model predictions. In Proceedings of the 31st International Conference on
Neural Information Processing Systems (NIPS'17). Curran Associates Inc.,
Red Hook, NY, USA, 4768–4777.</p>
<p>Redell, N. (2019). Shapley Decomposition of R-Squared in Machine Learning
Models. arXiv preprint: https://doi.org/10.48550/arXiv.1908.09718</p>
<p>Gelman, A., Goodrich, B., Gabry, J., &amp; Vehtari, A. (2019). R-squared for
Bayesian Regression Models. The American Statistician, 73(3), 307–309.</p>
<p>Joseph, A. Parametric inference with universal function approximators (2019).
Bank of England working papers 784, Bank of England, revised 22 Jul 2020.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Mario Grassi <a href="mailto:mario.grassi@unipv.it">mario.grassi@unipv.it</a></p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># load ALS data</span></span></span>
<span class="r-in"><span><span class="va">ig</span><span class="op">&lt;-</span> <span class="va">alsData</span><span class="op">$</span><span class="va">graph</span></span></span>
<span class="r-in"><span><span class="va">data</span><span class="op">&lt;-</span> <span class="va">alsData</span><span class="op">$</span><span class="va">exprs</span></span></span>
<span class="r-in"><span><span class="va">data</span><span class="op">&lt;-</span> <span class="fu">transformData</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">$</span><span class="va">data</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Conducting the nonparanormal transformation via shrunkun ECDF...done.</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#...with train-test (0.5-0.5) samples</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">train</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">rf0</span><span class="op">&lt;-</span> <span class="fu"><a href="SEMml.html">SEMml</a></span><span class="op">(</span><span class="va">ig</span>, <span class="va">data</span><span class="op">[</span><span class="va">train</span>, <span class="op">]</span>, algo<span class="op">=</span><span class="st">"rf"</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Running SEM model via ML...</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  done.</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> RF solver ended normally after 23 iterations</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>  logL:-33.16687  srmr:0.086188</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">res</span><span class="op">&lt;-</span> <span class="fu">getShapleyR2</span><span class="op">(</span><span class="va">rf0</span>, <span class="va">data</span><span class="op">[</span><span class="op">-</span><span class="va">train</span>, <span class="op">]</span>, thr<span class="op">=</span><span class="cn">NULL</span>, verbose<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="getShapleyR2-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu">E</span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">dag</span><span class="op">)</span><span class="op">$</span><span class="va">color</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     gray50       red2 royalblue3 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         32          7          6 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># shapley R2 per response variables</span></span></span>
<span class="r-in"><span><span class="va">R2</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">est</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">Y</span><span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">est</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">R2Y</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">R2</span><span class="op">~</span><span class="va">Y</span>,data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">R2</span>,<span class="va">Y</span><span class="op">)</span>,FUN<span class="op">=</span><span class="st">"sum"</span><span class="op">)</span>;<span class="va">R2Y</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        Y        R2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1  10452 0.3074106</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2   1432 0.2746912</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3   1616 0.1025127</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4   4217 0.2416770</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5   4741 0.2133041</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 6   4744 0.2336151</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 7   4747 0.3015739</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 8  54205 0.2243528</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 9   5530 0.4424930</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10  5532 0.3852137</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 11  5533 0.3368840</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 12  5534 0.4944426</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 13  5535 0.5919868</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 14  5600 0.2887038</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 15  5603 0.0000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 16  5606 0.2963567</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 17  5608 0.5054904</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 18   596 0.2057984</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 19  6300 0.3769140</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20 79139 0.4867639</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 21   836 0.5841519</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 22 84134 0.4718743</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 23   842 0.3401094</span>
<span class="r-in"><span><span class="va">r2</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">R2Y</span><span class="op">$</span><span class="va">R2</span><span class="op">)</span>;<span class="va">r2</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.3350574</span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Mario Grassi, Barbara Tarantino.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer></div>






  </body></html>

